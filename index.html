<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Auth0 Example on GitHub Pages</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
</head>
<body>
  <h1>Auth0 Authentication Example</h1>
  <button id="login">Login</button>
  <button id="logout" style="display:none;">Logout</button>
  <div id="profile"></div>
  <script>
    let auth0 = null;

    async function configureClient() {
      console.log('Configuring Auth0 client...');
      const redirectUri = window.location.origin;
      alert(`Redirect URI: ${redirectUri}`); // Show redirect_uri in an alert for manual verification
      auth0 = await createAuth0Client({
        domain: 'dev-zukti-tech.uk.auth0.com',
        client_id: 'IfpGUsKwXt67G9qDiIUk79h73CnVGeNy',
        authorizationParams: {
          redirect_uri: redirectUri,
          scope: 'openid profile email' // Explicitly include the scope parameter
        }
      });
      console.log('Auth0 client configured.');
    }

    async function login() {
      console.log('Login button clicked');
      try {
        await auth0.loginWithRedirect({
          authorizationParams: {
              prompt: 'login'
        }
        });
        console.log('Redirecting to Auth0 login page...');
      } catch (err) {
        console.error('Login error:', err);
      }
    }

    async function logout() {
      console.log('Logout button clicked');
      try {
        auth0.logout({ logoutParams: { returnTo: window.location.origin } });
        console.log('Logged out successfully.');
      } catch (err) {
        console.error('Logout error:', err);
      }
    }

    async function handleAuth() {
      console.log('Handling authentication...');
      await configureClient();

      if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
        console.log('Handling redirect callback...');
        try {
          await auth0.handleRedirectCallback();
          console.log('Redirect callback handled successfully.');
        } catch (err) {
          console.error('Error handling redirect callback:', err);
        }
        window.history.replaceState({}, document.title, '/');
      }

      const isAuthenticated = await auth0.isAuthenticated();
      console.log('Is authenticated:', isAuthenticated);

      if (!isAuthenticated) {
        console.log('User not authenticated, redirecting to login...');
        await auth0.loginWithRedirect();
        return;
      }

      document.getElementById('login').style.display = isAuthenticated ? 'none' : 'inline-block';
      document.getElementById('logout').style.display = isAuthenticated ? 'inline-block' : 'none';

      if (isAuthenticated) {
        try {
          const user = await auth0.getUser();
          console.log('User:', user);
          document.getElementById('profile').innerText = 'Logged in as: ' + user.name;
        } catch (err) {
          console.error('Error fetching user profile:', err);
        }
      } else {
        document.getElementById('profile').innerText = '';
      }
    }

    window.onload = handleAuth;
    document.getElementById('login').addEventListener('click', login);
    document.getElementById('logout').addEventListener('click', logout);
  </script>
</body>
</html>
